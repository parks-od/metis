name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # 1. ë³€ê²½ ê°ì§€ (Changes Detection)
  changes:
    runs-on: ubuntu-latest
    outputs:
      client: ${{ steps.filter.outputs.client }}
      server: ${{ steps.filter.outputs.server }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            client:
              - 'apps/client/**'
              - 'package.json'
              - 'pnpm-workspace.yaml'
            server:
              - 'apps/server/**'
              - 'package.json'
              - 'pnpm-workspace.yaml'

  # 2. Client CI (Frontend)
  client-ci:
    needs: changes
    if: ${{ needs.changes.outputs.client == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./apps/client

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js & pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        run_install: false

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'

    - name: Install Dependencies
      run: pnpm install --frozen-lockfile

    - name: ğŸ” Lint Check
      run: pnpm lint

    # Note: build script in Next.js runs type-check automatically, but distinct step is clearer
    # If no explicit type-check script, we can rely on build or add one.
    # Assuming 'build' covers type checking for Next.js
    - name: ğŸ—ï¸ Build Check
      run: pnpm build

  # 3. Server CI (Backend)
  server-ci:
    needs: changes
    if: ${{ needs.changes.outputs.server == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./apps/server

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js & pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        run_install: false

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'

    - name: Install Dependencies
      run: pnpm install --frozen-lockfile

    - name: ğŸ” Lint Check
      run: pnpm lint

    - name: ğŸ§ª Unit Test
      # If DB connection is needed for tests, consider adding a service container or mocking.
      # For now, running standard test script.
      run: pnpm test

    - name: ğŸ—ï¸ Build Check
      run: pnpm build
